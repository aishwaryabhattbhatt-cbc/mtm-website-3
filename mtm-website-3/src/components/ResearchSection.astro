---
// ResearchSection.astro
// Figma node: 1:9423 â€” "Access credible research on" animated section
import IconCard from './IconCard.astro';

const tabs = [
  { label: 'Technology Trends' },
  { label: 'Media Behaviour' },
  { label: '5000+ variables' },
];

const cards = [
  {
    id: 'card-ai-usage',
    label: 'AI Usage',
    src: 'https://www.figma.com/api/mcp/asset/f3a681fe-a53a-4860-a5bb-41d42f70683e',
  },
  {
    id: 'card-fast',
    label: 'FAST',
    src: 'https://www.figma.com/api/mcp/asset/fa8e679c-509e-4839-887d-76cd8bc771ec',
  },
  {
    id: 'card-svod',
    label: 'SVOD',
    src: 'https://www.figma.com/api/mcp/asset/6ead7ec3-ee3c-486e-9a9f-5d87ae00e46b',
  },
  {
    id: 'card-avod',
    label: 'AVOD',
    src: 'https://www.figma.com/api/mcp/asset/d9105888-c61d-4678-ba3c-4a9d0bf8b7a9',
  },
  {
    id: 'card-gaming',
    label: 'Gaming',
    src: 'https://www.figma.com/api/mcp/asset/fa8e679c-509e-4839-887d-76cd8bc771ec',
  },
  {
    id: 'card-news',
    label: 'News',
    src: 'https://www.figma.com/api/mcp/asset/f3a681fe-a53a-4860-a5bb-41d42f70683e',
  },
  {
    id: 'card-social',
    label: 'Social',
    src: 'https://www.figma.com/api/mcp/asset/6ead7ec3-ee3c-486e-9a9f-5d87ae00e46b',
  },
  {
    id: 'card-podcasts',
    label: 'Podcasts',
    src: 'https://www.figma.com/api/mcp/asset/d9105888-c61d-4678-ba3c-4a9d0bf8b7a9',
  },
  {
    id: 'card-mobile',
    label: 'Mobile',
    src: 'https://www.figma.com/api/mcp/asset/fa8e679c-509e-4839-887d-76cd8bc771ec',
  },
  {
    id: 'card-ecommerce',
    label: 'Ecommerce',
    src: 'https://www.figma.com/api/mcp/asset/f3a681fe-a53a-4860-a5bb-41d42f70683e',
  },
];

const screenSrc = '/images/dashboard.png';
---

<section class="research-section">
  <h2 class="heading heading-fly-in">Access credible research on</h2>

  <div class="content content-fly-in">

    <!-- LEFT: Topic Tabs -->
    <div class="left-text">
      {tabs.map((tab, i) => (
        <div
          class="tab-item"
          data-tab={i}
        >
          {tab.label}
        </div>
      ))}
    </div>

    <!-- RIGHT: Visual -->
    <div class="right-visual" id="rightVisual">

      <!-- Dashboard screenshot -->
      <div class="screen-wrapper">
        <div class="dashboard-media">
          <img id="research-dashboard-image" src={screenSrc} alt="Research dashboard" loading="lazy" />
        </div>

        <div class="cards-layer">
          <!-- Floating Icon Cards -->
          {cards.map((card) => (
            <IconCard
              id={card.id}
              icon={card.src}
              label={card.label}
              class="research-icon-card hidden"
            />
          ))}
        </div>
      </div>

    </div>
  </div>
</section>

<style>
  .research-section {
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 var(--grid-gap);
    font-family: 'Roboto', sans-serif;
    position: absolute;
    left: 0;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    z-index: 20;
  }

  @media (min-width: 768px) {
    .research-section {
      padding-left: var(--grid-gap-md);
      padding-right: var(--grid-gap-md);
    }
  }

  @media (min-width: 1024px) {
    .research-section {
      padding-left: var(--grid-gap-lg);
      padding-right: var(--grid-gap-lg);
    }
  }

  .heading {
    font-family: var(--font-family-heading);
    font-size: clamp(32px, 4vw, 51px);
    font-weight: 300;
    color: #1a1a1a;
    letter-spacing: -0.06em;
    line-height: 1;
    margin-bottom: 12px;
  }

  .heading-fly-in {
    opacity: 0;
    transform: translateY(26px);
    transition: opacity 0.65s ease, transform 0.65s cubic-bezier(0.2, 0.7, 0.2, 1);
    will-change: opacity, transform;
  }

  .heading-fly-in.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  .content {
    display: flex;
    align-items: center;
    width: 100%;
    gap: 40px;
  }

  .content-fly-in {
    opacity: 0;
    transform: translateY(26px);
    transition: opacity 0.65s ease 1s, transform 0.65s cubic-bezier(0.2, 0.7, 0.2, 1) 1s;
    will-change: opacity, transform;
  }

  .content-fly-in.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  /* LEFT TABS */
  .left-text {
    position: relative;
    --tab-progress: 0%;
    --tab-progress-duration: 3000ms;
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding-left: 24px;
    flex-shrink: 0;
    width: 320px;
    margin-right: auto;
  }

  .left-text::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 6px;
    border-radius: 999px;
    background: #d9d9d9;
  }

  .left-text::after {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    width: 6px;
    height: var(--tab-progress);
    border-radius: 999px;
    background: linear-gradient(
      to bottom,
      #0DC57E 0%,
      #54A2E4 35.0962%,
      #7B76FF 65%,
      #CB61D8 90%
    );
    transition: height var(--tab-progress-duration) linear;
  }

  .tab-item {
    font-family: 'Roboto', sans-serif;
    font-weight: 400;
    font-size: clamp(28px, 3.5vw, 44px);
    letter-spacing: -0.06em;
    line-height: 1.2;
    color: #c5c5c5;
    cursor: pointer;
    transition: color 0.4s ease;
    user-select: none;
    white-space: nowrap;
  }

  .tab-item:hover {
    color: #888;
  }

  .tab-item.active {
    color: #1a1a1a;
  }

  .tab-item.is-disabled {
    color: #c5c5c5;
    pointer-events: none;
  }

  /* RIGHT VISUAL */
  .right-visual {
    position: relative;
    flex: 1 1 auto;
    width: auto;
    min-width: 0;
    margin-left: auto;
  }

  .screen-wrapper {
    position: relative;
    margin-left: auto;
    width: 95%;
    aspect-ratio: 16 / 9;
    overflow: visible;
    box-shadow: none;
    background: transparent;
  }

  .dashboard-media {
    position: absolute;
    inset: 0;
    border-radius: 12px;
    overflow: hidden;
    background: transparent;
  }

  .screen-wrapper img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    margin-top: 0;
    background: transparent;
    opacity: 1;
    visibility: visible;
    transition: opacity 0.45s ease, visibility 0s linear 0s;
  }

  .screen-wrapper img.is-hidden {
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.45s ease, visibility 0s linear 0.45s;
  }

  .cards-layer {
    position: absolute;
    inset: 0;
    z-index: 2;
    pointer-events: none;
  }

  .screen-wrapper.is-empty::after {
    content: '';
    position: absolute;
    inset: 0;
    background: transparent;
  }

  :global(.research-icon-card.hidden) {
    opacity: 0;
    transform: scale(0.8);
    pointer-events: none;
  }

  .icon-pos-gui-toggle {
    position: absolute;
    right: 0;
    bottom: -46px;
    z-index: 50;
    border: 1px solid #d8d8d8;
    background: #ffffff;
    border-radius: 8px;
    padding: 7px 12px;
    font-size: 12px;
    cursor: pointer;
  }

  .icon-pos-gui {
    position: absolute;
    right: 0;
    top: 0;
    z-index: 55;
    width: 260px;
    background: rgba(255, 255, 255, 0.96);
    border: 1px solid #d9d9d9;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    padding: 12px;
    display: none;
    gap: 8px;
    font-size: 12px;
  }

  .icon-pos-gui.is-open {
    display: grid;
  }

  .icon-pos-gui label {
    display: grid;
    gap: 4px;
  }

  .icon-pos-gui select,
  .icon-pos-gui input[type='range'] {
    width: 100%;
  }

  .icon-pos-gui-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }

  .icon-pos-gui-actions {
    display: flex;
    gap: 8px;
  }

  .icon-pos-gui-actions button {
    border: 1px solid #d8d8d8;
    background: #fff;
    border-radius: 8px;
    padding: 6px 8px;
    font-size: 12px;
    cursor: pointer;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .content {
      flex-direction: column;
    }

    .right-visual {
      width: 100%;
      height: auto;
    }

    .left-text {
      width: 100%;
      padding-left: 0;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 12px;
    }

    .tab-item {
      font-size: 22px;
    }

    :global(.research-icon-card) {
      width: 84px;
      height: 84px;
    }
  }
</style>

<script>
  // Card positions per tab index
  type CardPos = { top: string; left: string; visible: boolean };
  type CardConfig = Record<string, CardPos>;
  type TabState = {
    dashboardSrc: string | null;
    cards: CardConfig;
  };

  const tabStates: TabState[] = [
    // Tab 0: Technology Trends
    {
      dashboardSrc: '/images/dashboard.png',
      cards: {
        'card-ai-usage': { top: '25%', left: '83.5%', visible: true },
        'card-fast':     { top: '58%', left: '6.5%', visible: true },
        'card-svod':     { top: '20.5%', left: '4%', visible: true },
        'card-avod':     { top: '59.5%', left: '81.5%', visible: true },
        'card-gaming':   { top: '10%', left: '10%', visible: false },
        'card-news':     { top: '12%', left: '42%', visible: false },
        'card-social':   { top: '42%', left: '24%', visible: false },
        'card-podcasts': { top: '66%', left: '30%', visible: false },
        'card-mobile':   { top: '68%', left: '62%', visible: false },
        'card-ecommerce':{ top: '36%', left: '84%', visible: false },
      },
    },
    // Tab 1: Media Behaviour
    {
      dashboardSrc: '/images/dashboard.png',
      cards: {
        'card-ai-usage': { top: '66%', left: '6%', visible: true },
        'card-fast':     { top: '0%', left: '19.5%', visible: true },
        'card-svod':     { top: '79.5%', left: '66%', visible: true },
        'card-avod':     { top: '56.5%', left: '84%', visible: true },
        'card-gaming':   { top: '32.5%', left: '3%', visible: true },
        'card-news':     { top: '18%', left: '81.5%', visible: true },
        'card-social':   { top: '22%', left: '28%', visible: false },
        'card-podcasts': { top: '80%', left: '30%', visible: false },
        'card-mobile':   { top: '44%', left: '30%', visible: false },
        'card-ecommerce':{ top: '48%', left: '52%', visible: false },
      },
    },
    // Tab 2: 5000+ variables
    {
      dashboardSrc: null,
      cards: {
        // 4 columns centered in frame:
        // grid width = 460px (4*100 + 3*20), height = 340px
        // origin = (50% - 230px, 50% - 170px)
        // Col 1: x=0, y=60/180 (center-aligned to 3-card columns)
        'card-ai-usage': { top: 'calc(50% - 110px)', left: 'calc(50% - 230px)', visible: true },
        'card-gaming':   { top: 'calc(50% + 10px)',  left: 'calc(50% - 230px)', visible: true },
        // Col 2: x=120, y=0/120/240
        'card-avod':     { top: 'calc(50% - 170px)', left: 'calc(50% - 110px)', visible: true },
        'card-news':     { top: 'calc(50% - 50px)',  left: 'calc(50% - 110px)', visible: true },
        'card-podcasts': { top: 'calc(50% + 70px)',  left: 'calc(50% - 110px)', visible: true },
        // Col 3: x=240, y=0/120/240
        'card-svod':     { top: 'calc(50% - 170px)', left: 'calc(50% + 10px)',  visible: true },
        'card-fast':     { top: 'calc(50% - 50px)',  left: 'calc(50% + 10px)',  visible: true },
        'card-mobile':   { top: 'calc(50% + 70px)',  left: 'calc(50% + 10px)',  visible: true },
        // Col 4: x=360, y=60/180 (center-aligned to 3-card columns)
        'card-social':   { top: 'calc(50% - 110px)', left: 'calc(50% + 130px)', visible: true },
        'card-ecommerce':{ top: 'calc(50% + 10px)',  left: 'calc(50% + 130px)', visible: true },
      },
    },
  ];

  let currentTab = -1;
  const TAB_DURATION_MS = 3000;
  const tabs = document.querySelectorAll<HTMLElement>('.tab-item');
  const section = document.querySelector<HTMLElement>('.research-section');
  const heading = section?.querySelector<HTMLElement>('.heading-fly-in');
  const contentBlock = section?.querySelector<HTMLElement>('.content-fly-in');
  const leftText = section?.querySelector<HTMLElement>('.left-text');
  const dashboardImage = section?.querySelector<HTMLImageElement>('#research-dashboard-image');
  const dashboardFrame = section?.querySelector<HTMLElement>('.screen-wrapper');
  const iconCards = section?.querySelectorAll<HTMLElement>('.research-icon-card');

  function parsePercentValue(value: string): number {
    const parsed = Number.parseFloat(value.replace('%', ''));
    return Number.isFinite(parsed) ? parsed : 0;
  }

  function applyConfig(idx: number, skipTransition = false) {
    const state = tabStates[idx];
    const config = state.cards;

    if (dashboardImage) {
      if (state.dashboardSrc) {
        dashboardImage.src = state.dashboardSrc;
        dashboardImage.classList.remove('is-hidden');
        dashboardFrame?.classList.remove('is-empty');
      } else {
        dashboardImage.classList.add('is-hidden');
        dashboardFrame?.classList.add('is-empty');
      }
    }

    Object.entries(config).forEach(([id, pos]) => {
      const card = document.getElementById(id);
      if (!card) return;

      if (skipTransition) {
        card.style.transition = 'none';
      }

      card.style.top = pos.top;
      card.style.left = pos.left;
      card.classList.toggle('hidden', !pos.visible);

      if (skipTransition) {
        // Re-enable transitions after two frames
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            card.style.transition = '';
          });
        });
      }
    });
  }

  function setTab(idx: number, progressDurationMs = TAB_DURATION_MS) {
    if (idx === currentTab) return;
    currentTab = idx;
    tabs.forEach((t, i) => t.classList.toggle('active', i === idx));
    applyConfig(idx);
    updateTabProgressBar(idx, progressDurationMs);
  }

  function updateTabProgressBar(idx: number, durationMs = TAB_DURATION_MS, immediate = false) {
    if (!leftText) return;
    const progress = ((idx + 1) / 3) * 100;
    leftText.style.setProperty('--tab-progress-duration', `${immediate ? 0 : durationMs}ms`);
    leftText.style.setProperty('--tab-progress', `${progress}%`);
  }

  // Attach click listeners
  tabs.forEach((tab, i) => {
    tab.addEventListener('click', () => {
      if (!hasPlaybackUnlocked) return;
      setTab(i, 220);
    });
  });

  let autoTimer: number | null = null;
  let isInView = false;
  let hasCompletedSingleLoop = false;
  let hasStartedPlayback = false;
  let hasPlaybackUnlocked = false;

  function setTabsEnabled(enabled: boolean) {
    tabs.forEach((tab) => tab.classList.toggle('is-disabled', !enabled));
  }

  function setAllIconsHidden(hidden: boolean) {
    iconCards?.forEach((card) => card.classList.toggle('hidden', hidden));
  }

  function startAutoRotate() {
    if (!isInView || autoTimer !== null || tabs.length <= 1 || hasCompletedSingleLoop) return;
    autoTimer = window.setInterval(() => {
      // Run one forward cycle only: tab1 -> tab2 -> tab3, then stop.
      if (currentTab >= tabs.length - 1) {
        hasCompletedSingleLoop = true;
        stopAutoRotate();
        return;
      }
      const nextTab = currentTab + 1;
      setTab(nextTab, TAB_DURATION_MS);
    }, TAB_DURATION_MS);
  }

  function stopAutoRotate() {
    if (autoTimer === null) return;
    window.clearInterval(autoTimer);
    autoTimer = null;
  }

  // Pause on hover
  section?.addEventListener('mouseenter', stopAutoRotate);
  section?.addEventListener('mouseleave', () => {
    startAutoRotate();
  });

  // Init default state: no active tab interactions and no icons shown.
  setAllIconsHidden(true);
  setTabsEnabled(false);
  // Start at 0 and wait for full in-view before beginning playback.
  updateTabProgressBar(-1, 0, true);

  // Start animation only when section is in viewport
  if (section) {
    // Heading reveal: trigger sooner as user scrolls from Hero 1 into Hero 2.
    const headingObserver = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting) {
          heading?.classList.add('is-visible');
          contentBlock?.classList.add('is-visible');
          headingObserver.disconnect();
        }
      },
      { threshold: 0.25 }
    );

    headingObserver.observe(section);

    const observer = new IntersectionObserver(
      ([entry]) => {
        isInView = entry.isIntersecting && entry.intersectionRatio >= 0.99;
        if (isInView) {
          if (!hasStartedPlayback) {
            hasStartedPlayback = true;
            hasPlaybackUnlocked = true;
            setTabsEnabled(true);
            setTab(0, TAB_DURATION_MS);
          }
          startAutoRotate();
        } else {
          stopAutoRotate();
        }
      },
      {
        threshold: [0.99, 1]
      }
    );

    observer.observe(section);
  }

  function initIconPositionGui() {
    if (!section) return;

    const editableTabIndexes = [0, 1];
    const editableCardIds = Object.keys(tabStates[0].cards);

    const gui = document.createElement('div');
    gui.className = 'icon-pos-gui';
    gui.innerHTML = `
      <strong>Icon Position GUI</strong>
      <label>
        Tab
        <select id="iconGuiTab">
          <option value="0">Tab 1: Technology Trends</option>
          <option value="1">Tab 2: Media Behaviour</option>
        </select>
      </label>
      <label>
        Icon
        <select id="iconGuiCard">
          ${editableCardIds.map((id) => `<option value="${id}">${id}</option>`).join('')}
        </select>
      </label>
      <label>
        Left (%)
        <input id="iconGuiLeft" type="range" min="0" max="100" step="0.5" />
      </label>
      <div class="icon-pos-gui-row"><span>Left value</span><span id="iconGuiLeftValue"></span></div>
      <label>
        Top (%)
        <input id="iconGuiTop" type="range" min="0" max="100" step="0.5" />
      </label>
      <div class="icon-pos-gui-row"><span>Top value</span><span id="iconGuiTopValue"></span></div>
      <label class="icon-pos-gui-row">
        <span>Visible</span>
        <input id="iconGuiVisible" type="checkbox" checked />
      </label>
      <div class="icon-pos-gui-actions">
        <button id="iconGuiCopy" type="button">Copy Tab JSON</button>
      </div>
    `;

    const toggleButton = document.createElement('button');
    toggleButton.className = 'icon-pos-gui-toggle';
    toggleButton.type = 'button';
    toggleButton.textContent = 'Icon GUI';

    section.appendChild(gui);
    section.appendChild(toggleButton);

    const tabSelect = gui.querySelector<HTMLSelectElement>('#iconGuiTab');
    const cardSelect = gui.querySelector<HTMLSelectElement>('#iconGuiCard');
    const leftInput = gui.querySelector<HTMLInputElement>('#iconGuiLeft');
    const topInput = gui.querySelector<HTMLInputElement>('#iconGuiTop');
    const visibleInput = gui.querySelector<HTMLInputElement>('#iconGuiVisible');
    const leftValue = gui.querySelector<HTMLSpanElement>('#iconGuiLeftValue');
    const topValue = gui.querySelector<HTMLSpanElement>('#iconGuiTopValue');
    const copyButton = gui.querySelector<HTMLButtonElement>('#iconGuiCopy');

    if (!tabSelect || !cardSelect || !leftInput || !topInput || !visibleInput || !leftValue || !topValue || !copyButton) {
      return;
    }

    function syncGuiFromState() {
      const tabIdx = Number(tabSelect.value);
      const cardId = cardSelect.value;
      const cardState = tabStates[tabIdx].cards[cardId];
      leftInput.value = String(parsePercentValue(cardState.left));
      topInput.value = String(parsePercentValue(cardState.top));
      visibleInput.checked = cardState.visible;
      leftValue.textContent = `${leftInput.value}%`;
      topValue.textContent = `${topInput.value}%`;
    }

    function applyGuiToState() {
      const tabIdx = Number(tabSelect.value);
      if (!editableTabIndexes.includes(tabIdx)) return;
      const cardId = cardSelect.value;
      const nextLeft = `${leftInput.value}%`;
      const nextTop = `${topInput.value}%`;
      tabStates[tabIdx].cards[cardId].left = nextLeft;
      tabStates[tabIdx].cards[cardId].top = nextTop;
      tabStates[tabIdx].cards[cardId].visible = visibleInput.checked;
      leftValue.textContent = nextLeft;
      topValue.textContent = nextTop;

      if (currentTab === tabIdx) {
        applyConfig(currentTab);
      }
    }

    tabSelect.addEventListener('change', () => {
      const selectedTabIdx = Number(tabSelect.value);
      setTab(selectedTabIdx);
      syncGuiFromState();
    });
    cardSelect.addEventListener('change', syncGuiFromState);
    leftInput.addEventListener('input', applyGuiToState);
    topInput.addEventListener('input', applyGuiToState);
    visibleInput.addEventListener('change', applyGuiToState);

    copyButton.addEventListener('click', async () => {
      const tabIdx = Number(tabSelect.value);
      const payload = JSON.stringify(tabStates[tabIdx].cards, null, 2);
      await navigator.clipboard.writeText(payload);
      copyButton.textContent = 'Copied';
      window.setTimeout(() => {
        copyButton.textContent = 'Copy Tab JSON';
      }, 1200);
    });

    toggleButton.addEventListener('click', () => {
      gui.classList.toggle('is-open');
      if (gui.classList.contains('is-open')) {
        stopAutoRotate();
        syncGuiFromState();
      }
    });

    syncGuiFromState();
  }

  // GUI kept in code but hidden for now.
  // initIconPositionGui();
</script>
